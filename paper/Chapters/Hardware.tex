\chapter{Developing the Hardware} % Main chapter title

\label{Chapter4} % Change X to a consecutive number; for referencing this chapter elsewhere, use \ref{ChapterX}

\todosection

\section{Requirements}\label{sec:HardwareRequirements}

This section will explain the different constraints taken into account while developing the hardware portion of this project.
First, the hardware must be performant enough to provide a positive user experience (\ref{sec:HardwarePerformance}), and secondly the product must be cheap enough to justify it over similar alternatives (\ref{sec:HardwareCost}).

\subsection{Performance}\label{sec:HardwarePerformance}

When considering how much power needs to be incorporated in to the miniature computer, it is important to consider a number of factors, such as: having enough power to stream audio and video over the internet, not consuming too much power so as to require an expensive battery, have a fast enough connection to the internet to deliver data with the least possible latency, and having a reasonable footprint to be used as a mobile device.

Immediately, the device must be capable of decoding and rendering video that is streamed over the internet.
Such video processing is a relatively expensive process that cannot easily be done with something such as a micro controller or even a single core CPU seen on Single Board Computers (SBC) such as the Raspberry Pi Zero due to the lack of working memory and processing power \cite{picockpit_2021}.
\todoadvisor{Add more detail?}
Though at the same time, it is important to not simply build a powerful system akin to a laptop that will consume more power.
It makes no sense to built a powerful mini-computer when all it will ever be used to is to connect to another computer, and the added power draw would require a larger battery in order to stay operational for decent periods of time.
Instead it should be cut down and distilled into something that can do it's job as efficiently as possible.

The second major performance requirement of the hardware is the ability to stream this data over the internet as quickly as possible.
Because all of the data being sent to the device is live information from the host machine, the video and audio streams cannot simply be buffered in advance and played when it's ready like a recorded video.
Instead, the data must be displayed as it is received so that the user can have a smooth experience without having to wait for their keystrokes or mouse movements to be registered.
While Wi-Fi is growing ever quicker and more reliable, and should absolutely be included as a way to connected to the internet, the best way to ensure a stable and speedy connection is to use an Ethernet Cable.
This will help the device work on a consistent connection when used at a desk, while also providing a way to connect while on-the-go.

This leads to the desire for a portable design that can be used both in a conducive environnement such as a desk or while mobile.
The hardware should have the ability to be powered by a chord plugging into the device, or by an internal battery.
This alone presents a number of difficult concerns, but those will be addressed later in this chapter\todo{cite}.
Such a requirement leads to a clear benefit of integrating crucial computers such as a battery and a screen into the hardware design, while leaving as many ports open such as ethernet and USB for the user to take advantage of.


\subsection{Cost}\label{sec:HardwareCost}

Because this project consists of both a Hardware and Software component to make up a complete product, there must be reason for both to be developed.
While the software has the benefit of being the foundation for the connection between host and client machines, there are already hardware solutions that would theoretically be able to run such software.
Since the goal of this project is to save money by not needing to purchase an expensive mobile device to connect to a powerful desktop computer, there must be benefit in the hardware to warrant it's existence over repurposing something like an old laptop.
The most obvious metric of this is the actual cost of the hardware.
If the hardware can be produced at a high enough quality at a low enough cost to bring value over just a software solution, then it should be considered moving forward.
Otherwise it may prove that the development of the software should focus on compatibility so the hardware can be provided by the end user.

Generally speaking, the goal for the hardware of this project is to cost approximately \$100-\$200 to produce a single unit.
This comes with the understanding that hardware production in bulk often costs significantly less than assembling a single product.
The reasoning for this cost comes down to reasonableness: the price of the final product should be less than what it would cost to purchase or refurbish an existing computer to do the job of this project.
Otherwise, as stated before, the software of this project may prove more valuable than the hardware as long as compatibility is kept in the forefront of development.


\section{Choosing Parts}\label{sec:ChoosingParts}

When starting to choose parts for the hardware, there are many difficult questions to face.
First and foremost, the hardware had to be built with the time and resources available for this project.
Specifically, building a Single Board Computer\todoadvisor{introduce acronyms the first time they're used}\todo{This was introduced in 4.1.1, should it also be done here?} from scratch would be completely infeasible, but the goal was also not to simply purchase an off the shelf SBC that was not tailored to the task at hand such as a traditional Raspberry Pi.
Instead, a better suited solution would be to utilize a \emph{Raspberry Pi Compute Module 4 (CM4)} which has \enquote{The power of Raspberry Pi 4 in a compact form factor for deeply embedded applications} \cite{rpi_cm4}.
Boasting an incredibly small size and streamlined I/O, there only way to communicate with the Compute Module was through two tiny mezzanine connectors as shown in Figure \ref{fig:rpi_cm4_mezzanine}.
With no other pin outs for anything such as power, HDMI, or USB, everything had to be built on a custom Printed Circuit Board (PCB).

\begin{figure}[h]
  \centering
  \begin{minipage}{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{Figures/rpi_cm4}
    \captionsetup{width=.75\linewidth}
    \caption[Raspberry Pi Compute Module 4]{Raspberry Pi Compute Module 4, sizing\newline55 x 40mm}
    \label{fig:rpi_cm4}
  \end{minipage}\hfill
  \begin{minipage}{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{Figures/rpi_cm4_mezzanine}
    \captionsetup{width=.75\linewidth}
    \caption[Raspberry Pi Compute Module 4 Pin out]{Close-up of the pin out, with a 0.04mm pitch between pins}
    \label{fig:rpi_cm4_mezzanine}
  \end{minipage}
\end{figure}

This PCB would have to be designed so that the CM4 could be plugged into the board using the mezzanine connectors and rely on it for all inputs and outputs.
This, however, is only the beginning of what is required to develop the product.
Since the project would not use an off the shelf SBC like a regular Raspberry PI, the project would require only designing the PCB but also picking out all the components that would go onto the PCB, such as the USB ports themselves, the USB driver chip, and related components needed for operation.
Because the CM4 is designed to be as low-powered and compact as possible, some features that would usually be expected of such a device, like the USB ports, are disabled by default and must instead be built by the board designer.
While this helps greatly by removing extraneous components and features that aren't needed for this project, it also provides me with a \todo{does this sound sarcastic?}great opportunity to learn exactly what parts are being used in the hardware.

An invaluable resource while designing the PCB was the Official I/O board for the CM4 \cite{rpi_cm4_io}.
Though the PCB board would still have to be custom built and components would need to be replaced due to the current ongoing chip shortage, it provides a great foundation instead of starting from scratch.
Another massive benefit from working within the Raspberry Pi Ecosystem is their \todo{(re)move?}incredible documentation and community surrounding the boards.
Around the time this project was being started, the CM4 was just starting to get into the hands of makers and developers, and only a couple custom boards had actually been made by anyone other than Raspberry Pi themselves.
Even though this leaves the community with less of a bulk of knowledge to work with, it has provided a sort of comradery with everyone helping each other learn the new Compute Module together.
Members of the CM4 engineering team would even assist those on the forums to help them pick parts and design their own boards.

Following the example put forward by the existing boards, PCB parts were chosen to be integrated into the circuit as safely as possible.
Thankfully due to most parts following international standards, many parts were chosen simply because they followed the same standard as the CM4 (such as USB 2.0, or \emph{1PORT 1000 BASE-T} Ethernet) and were in stock.
What follows is a table of some components that had to be purchased apart from those that had been tested by the community, and the reason for their selection.
A full Bill of Materials can be found in Appendix \ref{AppendixB}.

\renewcommand*{\arraystretch}{1.5} % inner table padding
\begin{longtable}{|>{\raggedright\arraybackslash}p{0.2\linewidth}|>{\raggedright\arraybackslash}p{0.33\linewidth}|>{\raggedright\arraybackslash}p{0.46\linewidth}|}
  \hline
  \bfseries Purpose & \bfseries Manufacturer's Number &\bfseries Reason \\% Columns
  \hline
  USB-C Power in & \emph{USB4125-GF-A} by \enquote{GCT} & Most projects of this scale are powered by micro usb, but with USB-C gaining popularity, this component was picked for its low price and exclusive ability to transfer power without transfering data. \\
  \hline
  Ethernet Port & \emph{ARJM11D7-502-AB-EW2} by \enquote{Abracon LLC} & One of the few in-stock ethernet ports that supports \emph{1000 BASE-T} usage. The CM4 recommends the \emph{MagJack-A70-112-331N126} produced by \enquote{LINK-PP}, but that part is out of stock for at least another year as of writing. \\
  \hline
  USB Port & \emph{SS-52100-001} by \enquote{Stewart Connector} & Single flat port that supports USB 2.0. \\
  \hline
  HDMI Port & \emph{SS-53000-001} by \enquote{Stewart Connector} & Single flat port that supports HDMI 1.4. \\
  \hline
  Flat Flexible Cable Connector & \emph{FFC3B07-20-T} by \enquote{GCT} & A generic Flat Flexible Cable port that can be connected to anything. In this case, one is connected to the build-in screen's HDMI port, and another is connected to the screen's touch/power USB port. \\
  \hline
  2-Pin Through Hole Header & \emph{PREC002SAAN-RC} by \enquote{Sullins Connector Solutions} & A generic 2-pin header than can be used to bypass the power circuit as discussed in Section \ref{sec:Prototyping}. \\
  \hline
  HDMI Power Regulator & \emph{RT9742ENGJ5} by \enquote{Richtek USA Inc.} & The CM4 recommends the \emph{RT9742SNGV} from the same manufacturer, but it is out of stock. This part has slight differences that call for tweaks in the final layout. \\
  \hline
  SD-Card Power Regulator & \emph{RT9742VGJ5} by \enquote{Richtek USA Inc.} & The CM4 recommends the \emph{RT9742GGJ5F} from the same manufacturer, but it is out of stock. This part has slight differences that call for tweaks in the final layout. \\
  \hline
  Battery Voltage Regulator and Boost Converter & \emph{TPS61090RSAR} by \enquote{TPS61090RSAR} & Used to charge balance power usage from the USB-C port or the attached battery, favoring the external power when available. \\
  \hline
  Li-Po Battery Charge Management Controller & \emph{MCP73871-2CCI\_ML} by \enquote{Microchip Technology} & Used to charge the attached battery when attached to external power through the USB-C port. \\
  \hline
  4 Port USB Hub Controller & \emph{USB2504A-JT} by \enquote{Microchip Technology} & Used to control the four USB 2.0 ports and send the data to the CM4. The CM4 recommends the \emph{USB2514B-I/M2} by the same manufacturer, however it and all the parts in it's family are out of stock with at least a 52-week back order. Out of all the components, this has the highest potential to be problematic.\\
  \hline
  \caption[Selected PCB Components]{A non-exhaustive list of components that were chosen for this project.}
  \label{tab:SelectedComponents}
\end{longtable}
\todo[inline]{Should the above table have pictures? If so, where? Since the table is already pretty dense}

\section{Prototyping}\label{sec:Prototyping}

\begin{wrapfigure}{o}{0.37\textwidth}
  \centering
  \includegraphics[width=0.3\textwidth]{Figures/64-LQFP}
  \caption[USB Controller]{The USB controller, with 0.5mm between pins}
  \label{fig:USBController}
\end{wrapfigure}
Whenever working with electrical projects such as this, it is always a good idea to build up prototypes before committing to a final design that will be produced at the highest quality.
Usually breadboards and some breakout boards for Surface Mounted Devices (SMD) are a great way to develop a circuit without creating a full PCB; but due to the nature of the complex microchips required for this project as well as the dependence on the CM4's tiny mezzanine connectors, building a prototype using a breadboard is impractical given the time and resources available.
For example, the USB controller chip only has 0.5mm of space between each of it's 64 pins (Figure \ref{fig:USBController}), which would require a breakout board at least 7 times larger than the chip so that each each pin can be easily accessed by hand.
Not to mention the difficulty in wiring up that many pins along with the other related components which would need their own breakout boards either purchased or custom-designed.

\begin{figure}[h]
  \centering
  %Height instead of width because the image is rotated
  \includegraphics[height=0.9\textwidth,angle=90]{Figures/smt_breakout}
  \captionsetup{width=.8\linewidth}
  \caption[SMD Breakout Board]{A breakout board similar to what would be needer for the USB controller used on the custom PCB}
  \label{fig:smt_breakout}
\end{figure}

Instead, the first board was built out in a piecewise fashion, allowing each section of the board a way to fail without interrupting the rest of the board.
This allows each function of the board to be tested individually and in isolation so that changes could be made incrementally without needing to worry about their integration with the rest of the board.
\todo{convert first person to third person}For example, in order to build a system that would allow the board to be powered via USB or an internal battery, as well as charge the battery simultaneously, I would need to build a complex circuit consisting of parts neither I nor anyone I knew had used before.
Since power is obviously a critical component of the board, A secondary way of feeding power directly the board was built to bypass all that circuitry in case it fails.
In doing so, the board can still be powered and it's other features can be tested while a fix for that portion of the circuitry is developed for the next iteration.


\section{Designing the Printed Circuit Board}\label{sec:DesigningThePCB}

Because of the lack of prototyping options and the complexity of the circuit and it's components, the Printed Circuit Board was designed in a modular and piecewise fashion.
This allowed any single part of the circuit to fail without interfering with the other components.
Since the time and budget for this project was limited, the amount of revisioning was minimized by running the circuit by as many people as possible to catch any potential flaws before the board was manufactured.

\begin{wrapfigure}{r}{0.375\textwidth}
  \centering
  \includegraphics[width=0.3\textwidth]{Figures/kicad/close-ups/power-front}
  \caption[PCB Power Circuit]{The front side of the PCB's power circuit}
  \label{fig:PowerCircuit}
\end{wrapfigure}
Development started with arguably the most important part of the board: the power supply.
If the CM4 could not receive power, none of the project would work.
A feature of modern devices that has become ubiquitous as much as it has been taken for granted is the ability to charge a battery at the same time it is in use by the device.
This enables the device to be used portably until the battery runs out and then charge the device without needing to stop using it before moving again.
Though it proves to be slightly more complicated than simply connecting the two power supplies.
As seen in Figure \ref{fig:PowerCircuit},


\section{Manufacturing the Circuit Board}\label{sec:ManufacturingThePCB}

\todosection